version: 2.1
orbs:
    php:
        executors:
            composer:
                docker:
                    - image: composer
            phpstan:
                docker:
                    - image: phpstan/phpstan:latest
            php-cs-fixer:
                docker:
                    - image: herloct/php-cs-fixer:latest
        jobs:
            install:
                executor: composer
                working_directory: /var/www/project
                steps:
                  - checkout
                  - run: composer install
                  - persist_to_workspace:
                      root: /var/www/
                      paths:
                        - project
                  - run: make tests
            phpstan:
                executor: phpstan
                working_directory: /var/www/project
                steps:
                    - attach_workspace:
                        at: /var/www/
                    - run: phpstan analyse --level 5 src
            php-cs-fixer:
                executor: php-cs-fixer
                working_directory: /var/www/
                steps:
                    - attach_workspace:
                        at: /var/www/
                    - run: php-cs-fixer fix --dry-run --diff /var/www/project/src
workflows:
    build_and_test:
        jobs:
            - php/install
            - php/phpstan:
                requires:
                  - php/install
            - php/php-cs-fixer:
                requires:
                  - php/install
